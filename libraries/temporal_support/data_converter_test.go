package temporal_support

import (
	"context"
	"reflect"
	"testing"

	"go.temporal.io/sdk/converter"

	"github.com/stretchr/testify/require"
)

func getOpts() Options {
	opts := Options{
		EncryptionKey: []byte(developmentEncryptionStringKey),
	}
	return opts
}

func getEncryptionDataConverter() converter.DataConverter {
	encryptedDataConverter, _ := NewEncryptDataConverterV1(getOpts())
	return encryptedDataConverter
}

func testDataConverterFunction(t *testing.T, f interface{}, args ...interface{}) string {
	dc := getEncryptionDataConverter()
	input, err := dc.ToPayloads(args...)
	require.NoError(t, err, "ToPayloads found an err")

	var result []interface{}
	for _, v := range args {
		arg := reflect.New(reflect.TypeOf(v)).Interface()
		result = append(result, arg)
	}
	require.NoError(t, dc.FromPayloads(input, result...), "FromPayloads found an err")

	var targetArgs []reflect.Value
	for _, arg := range result {
		targetArgs = append(targetArgs, reflect.ValueOf(arg).Elem())
	}
	fnValue := reflect.ValueOf(f)
	retValues := fnValue.Call(targetArgs)
	return retValues[0].Interface().(string)
}

func toInterface(i interface{}) interface{} {
	return i
}

func TestDefaultDataConverter(t *testing.T) {
	t.Parallel()

	t.Run("result", func(t *testing.T) {
		f1 := func(ctx context.Context, r []byte) string {
			return "result"
		}
		r1 := testDataConverterFunction(t, f1, context.Background(), []byte("test"))
		require.Equal(t, r1, "result")
	})
	t.Run("empty", func(t *testing.T) {
		// No parameters.
		f2 := func() string {
			return "empty-result"
		}
		r2 := testDataConverterFunction(t, f2)
		require.Equal(t, r2, "empty-result")
	})
	t.Run("nil", func(t *testing.T) {
		// Nil parameter.
		f3 := func(r []byte) string {
			return "nil-result"
		}
		r3 := testDataConverterFunction(t, f3, []byte(""))
		require.Equal(t, r3, "nil-result")
	})
	t.Run("big payload", func(t *testing.T) {
		f1 := func(ctx context.Context, r []byte) string {
			return "result"
		}
		r1 := testDataConverterFunction(t, f1, context.Background(), getBigTemporalPayloadJSONExample())
		require.Equal(t, r1, "result")
	})
}

func testToStringsFunction(
	t *testing.T,
	dc converter.DataConverter,
	args ...interface{},
) []string {
	input, err := dc.ToPayloads(args...)
	require.NoError(t, err, err)

	strings := dc.ToStrings(input)

	return strings
}

func TestToStrings(t *testing.T) {
	t.Parallel()

	testStruct := struct {
		A string
		B int
	}{
		A: "hi",
		B: 3,
	}

	got := testToStringsFunction(t, getEncryptionDataConverter(),
		[]byte("test"),
		[]string{"hello", "world"},
		"hello world",
		42,
		testStruct)

	want := []string{
		"dGVzdA",
		"[\"hello\",\"world\"]",
		"\"hello world\"",
		"42",
		"{\"A\":\"hi\",\"B\":3}",
	}

	require.Equal(t, want, got)
}

func getBigTemporalPayloadJSONExample() []byte {
	return []byte("[\n  {\n    \"eventTime\": \"2021-01-08T00:54:29.000Z\",\n    \"eventType\": \"WorkflowExecutionStarted\",\n    \"eventId\": \"1\",\n    \"details\": {\n      \"workflowType\": {\n        \"name\": \"ScanUserFilesWorkflow\"\n      },\n      \"parentWorkflowNamespace\": \"gdrivedlp\",\n      \"parentWorkflowExecution\": {\n        \"workflowId\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\",\n        \"runId\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\"\n      },\n      \"parentInitiatedEventId\": \"40\",\n      \"taskQueue\": {\n        \"name\": \"gdrive-main\",\n        \"kind\": \"Normal\"\n      },\n      \"input\": {\n        \"payloads\": []\n      },\n      \"workflowExecutionTimeout\": 604800,\n      \"workflowRunTimeout\": 604800,\n      \"workflowTaskTimeout\": 60,\n      \"continuedExecutionRunId\": \"\",\n      \"initiator\": \"Workflow\",\n      \"continuedFailure\": null,\n      \"lastCompletionResult\": null,\n      \"originalExecutionRunId\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\",\n      \"identity\": \"\",\n      \"firstExecutionRunId\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\",\n      \"retryPolicy\": {\n        \"nonRetryableErrorTypes\": [],\n        \"initialInterval\": 90,\n        \"backoffCoefficient\": 4,\n        \"maximumInterval\": 86400,\n        \"maximumAttempts\": 3\n      },\n      \"attempt\": 1,\n      \"workflowExecutionExpirationTime\": null,\n      \"cronSchedule\": \"\",\n      \"firstWorkflowTaskBackoff\": 0,\n      \"memo\": null,\n      \"searchAttributes\": [],\n      \"prevAutoResetPoints\": null,\n      \"header\": {\n        \"fields\": {}\n      },\n      \"eventId\": \"1\",\n      \"eventType\": \"WorkflowExecutionStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:29 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"1\"\n        },\n        {\n          \"key\": \"workflowType.name\",\n          \"value\": \"ScanUserFilesWorkflow\"\n        },\n        {\n          \"key\": \"parentWorkflowNamespace\",\n          \"value\": \"gdrivedlp\"\n        },\n        {\n          \"key\": \"parentWorkflowExecution.workflowId\",\n          \"value\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\"\n        },\n        {\n          \"key\": \"parentWorkflowExecution.runId\",\n          \"routeLink\": {\n            \"name\": \"workflow/summary\",\n            \"params\": {\n              \"namespace\": \"gdrivedlp\",\n              \"runId\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\",\n              \"workflowId\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\"\n            }\n          },\n          \"value\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\"\n        },\n        {\n          \"key\": \"parentInitiatedEventId\",\n          \"value\": \"40\"\n        },\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrive-main\"\n            }\n          },\n          \"value\": \"gdrive-main\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Normal\"\n        },\n        {\n          \"key\": \"input\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"workflowExecutionTimeout\",\n          \"value\": 604800\n        },\n        {\n          \"key\": \"workflowRunTimeout\",\n          \"value\": 604800\n        },\n        {\n          \"key\": \"workflowTaskTimeout\",\n          \"value\": 60\n        },\n        {\n          \"key\": \"continuedExecutionRunId\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"initiator\",\n          \"value\": \"Workflow\"\n        },\n        {\n          \"key\": \"originalExecutionRunId\",\n          \"value\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"firstExecutionRunId\",\n          \"value\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\"\n        },\n        {\n          \"key\": \"retryPolicy.initialInterval\",\n          \"value\": 90\n        },\n        {\n          \"key\": \"retryPolicy.backoffCoefficient\",\n          \"value\": 4\n        },\n        {\n          \"key\": \"retryPolicy.maximumInterval\",\n          \"value\": 86400\n        },\n        {\n          \"key\": \"retryPolicy.maximumAttempts\",\n          \"value\": 3\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        },\n        {\n          \"key\": \"cronSchedule\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"firstWorkflowTaskBackoff\",\n          \"value\": 0\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:29 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:29 pm\",\n    \"timeElapsedDisplay\": \"Jan 7th 4:54:29 pm\",\n    \"eventSummary\": {\n      \"Close Timeout\": \"\",\n      \"identity\": \"\",\n      \"input\": {\n        \"payloads\": []\n      },\n      \"Parent\": {\n        \"routeLink\": {\n          \"name\": \"workflow/summary\",\n          \"params\": {\n            \"namespace\": \"gdrivedlp\",\n            \"workflowId\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\",\n            \"runId\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\"\n          }\n        },\n        \"text\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\"\n      },\n      \"Workflow\": \"ScanUserFilesWorkflow\",\n      \"eventId\": \"1\",\n      \"eventType\": \"WorkflowExecutionStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"Close Timeout\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"input\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"Parent\",\n          \"routeLink\": {\n            \"name\": \"workflow/summary\",\n            \"params\": {\n              \"namespace\": \"gdrivedlp\",\n              \"workflowId\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\",\n              \"runId\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\"\n            }\n          },\n          \"value\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\"\n        },\n        {\n          \"key\": \"Workflow\",\n          \"value\": \"ScanUserFilesWorkflow\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"workflowType\": {\n        \"name\": \"ScanUserFilesWorkflow\"\n      },\n      \"parentWorkflowNamespace\": \"gdrivedlp\",\n      \"parentWorkflowExecution\": {\n        \"workflowId\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\",\n        \"runId\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\"\n      },\n      \"parentInitiatedEventId\": \"40\",\n      \"taskQueue\": {\n        \"name\": \"gdrive-main\",\n        \"kind\": \"Normal\"\n      },\n      \"input\": {\n        \"payloads\": []\n      },\n      \"workflowExecutionTimeout\": 604800,\n      \"workflowRunTimeout\": 604800,\n      \"workflowTaskTimeout\": 60,\n      \"continuedExecutionRunId\": \"\",\n      \"initiator\": \"Workflow\",\n      \"continuedFailure\": null,\n      \"lastCompletionResult\": null,\n      \"originalExecutionRunId\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\",\n      \"identity\": \"\",\n      \"firstExecutionRunId\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\",\n      \"retryPolicy\": {\n        \"nonRetryableErrorTypes\": [],\n        \"initialInterval\": 90,\n        \"backoffCoefficient\": 4,\n        \"maximumInterval\": 86400,\n        \"maximumAttempts\": 3\n      },\n      \"attempt\": 1,\n      \"workflowExecutionExpirationTime\": null,\n      \"cronSchedule\": \"\",\n      \"firstWorkflowTaskBackoff\": 0,\n      \"memo\": null,\n      \"searchAttributes\": [],\n      \"prevAutoResetPoints\": null,\n      \"header\": {\n        \"fields\": {}\n      },\n      \"eventId\": \"1\",\n      \"eventType\": \"WorkflowExecutionStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"workflowType.name\",\n          \"value\": \"ScanUserFilesWorkflow\"\n        },\n        {\n          \"key\": \"parentWorkflowNamespace\",\n          \"value\": \"gdrivedlp\"\n        },\n        {\n          \"key\": \"parentWorkflowExecution.workflowId\",\n          \"value\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\"\n        },\n        {\n          \"key\": \"parentWorkflowExecution.runId\",\n          \"routeLink\": {\n            \"name\": \"workflow/summary\",\n            \"params\": {\n              \"namespace\": \"gdrivedlp\",\n              \"runId\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\",\n              \"workflowId\": \"4db81807-31b3-4545-ae22-9cf9c4d9ffbf-8-gdrive-scan\"\n            }\n          },\n          \"value\": \"db0e3f56-06e1-43c5-9813-7b46f9a4a343\"\n        },\n        {\n          \"key\": \"parentInitiatedEventId\",\n          \"value\": \"40\"\n        },\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrive-main\"\n            }\n          },\n          \"value\": \"gdrive-main\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Normal\"\n        },\n        {\n          \"key\": \"input\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"workflowExecutionTimeout\",\n          \"value\": 604800\n        },\n        {\n          \"key\": \"workflowRunTimeout\",\n          \"value\": 604800\n        },\n        {\n          \"key\": \"workflowTaskTimeout\",\n          \"value\": 60\n        },\n        {\n          \"key\": \"continuedExecutionRunId\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"initiator\",\n          \"value\": \"Workflow\"\n        },\n        {\n          \"key\": \"originalExecutionRunId\",\n          \"value\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"firstExecutionRunId\",\n          \"value\": \"bea9eb33-cc9f-4d44-8452-5136cff1999b\"\n        },\n        {\n          \"key\": \"retryPolicy.initialInterval\",\n          \"value\": 90\n        },\n        {\n          \"key\": \"retryPolicy.backoffCoefficient\",\n          \"value\": 4\n        },\n        {\n          \"key\": \"retryPolicy.maximumInterval\",\n          \"value\": 86400\n        },\n        {\n          \"key\": \"retryPolicy.maximumAttempts\",\n          \"value\": 3\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        },\n        {\n          \"key\": \"cronSchedule\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"firstWorkflowTaskBackoff\",\n          \"value\": 0\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:29.000Z\",\n    \"eventType\": \"WorkflowTaskScheduled\",\n    \"eventId\": \"2\",\n    \"details\": {\n      \"taskQueue\": {\n        \"name\": \"gdrive-main\",\n        \"kind\": \"Normal\"\n      },\n      \"startToCloseTimeout\": 60,\n      \"attempt\": 1,\n      \"eventId\": \"2\",\n      \"eventType\": \"WorkflowTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:29 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"2\"\n        },\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrive-main\"\n            }\n          },\n          \"value\": \"gdrive-main\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Normal\"\n        },\n        {\n          \"key\": \"startToCloseTimeout\",\n          \"value\": 60\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:29 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:29 pm\",\n    \"timeElapsedDisplay\": \"\",\n    \"eventSummary\": {\n      \"Taskqueue\": \"gdrive-main\",\n      \"Timeout\": \"\",\n      \"eventId\": \"2\",\n      \"eventType\": \"WorkflowTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"Taskqueue\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrive-main\"\n            }\n          },\n          \"value\": \"gdrive-main\"\n        },\n        {\n          \"key\": \"Timeout\",\n          \"value\": \"\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"taskQueue\": {\n        \"name\": \"gdrive-main\",\n        \"kind\": \"Normal\"\n      },\n      \"startToCloseTimeout\": 60,\n      \"attempt\": 1,\n      \"eventId\": \"2\",\n      \"eventType\": \"WorkflowTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrive-main\"\n            }\n          },\n          \"value\": \"gdrive-main\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Normal\"\n        },\n        {\n          \"key\": \"startToCloseTimeout\",\n          \"value\": 60\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:30.000Z\",\n    \"eventType\": \"WorkflowTaskStarted\",\n    \"eventId\": \"3\",\n    \"details\": {\n      \"scheduledEventId\": \"2\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"requestId\": \"b1dc768f-1583-459a-b0c7-b016ecd4813f\",\n      \"eventId\": \"3\",\n      \"eventType\": \"WorkflowTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:30 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"3\"\n        },\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"2\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"requestId\",\n          \"value\": \"b1dc768f-1583-459a-b0c7-b016ecd4813f\"\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:30 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:30 pm\",\n    \"timeElapsedDisplay\": \"1s (+1s)\",\n    \"eventSummary\": {\n      \"requestId\": \"b1dc768f-1583-459a-b0c7-b016ecd4813f\",\n      \"eventId\": \"3\",\n      \"eventType\": \"WorkflowTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"requestId\",\n          \"value\": \"b1dc768f-1583-459a-b0c7-b016ecd4813f\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"scheduledEventId\": \"2\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"requestId\": \"b1dc768f-1583-459a-b0c7-b016ecd4813f\",\n      \"eventId\": \"3\",\n      \"eventType\": \"WorkflowTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"2\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"requestId\",\n          \"value\": \"b1dc768f-1583-459a-b0c7-b016ecd4813f\"\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:30.000Z\",\n    \"eventType\": \"WorkflowTaskCompleted\",\n    \"eventId\": \"4\",\n    \"details\": {\n      \"scheduledEventId\": \"2\",\n      \"startedEventId\": \"3\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"binaryChecksum\": \"5efebc3d811f9d52125a215c4054ee11\",\n      \"eventId\": \"4\",\n      \"eventType\": \"WorkflowTaskCompleted\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:30 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"4\"\n        },\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"2\"\n        },\n        {\n          \"key\": \"startedEventId\",\n          \"value\": \"3\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"binaryChecksum\",\n          \"value\": \"5efebc3d811f9d52125a215c4054ee11\"\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:30 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:30 pm\",\n    \"timeElapsedDisplay\": \"1s\",\n    \"eventSummary\": {\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"eventId\": \"4\",\n      \"eventType\": \"WorkflowTaskCompleted\",\n      \"kvps\": [\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"scheduledEventId\": \"2\",\n      \"startedEventId\": \"3\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"binaryChecksum\": \"5efebc3d811f9d52125a215c4054ee11\",\n      \"eventId\": \"4\",\n      \"eventType\": \"WorkflowTaskCompleted\",\n      \"kvps\": [\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"2\"\n        },\n        {\n          \"key\": \"startedEventId\",\n          \"value\": \"3\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"binaryChecksum\",\n          \"value\": \"5efebc3d811f9d52125a215c4054ee11\"\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:30.000Z\",\n    \"eventType\": \"ActivityTaskScheduled\",\n    \"eventId\": \"5\",\n    \"details\": {\n      \"activityId\": \"5\",\n      \"activityType\": {\n        \"name\": \"GetUsersActivity\"\n      },\n      \"namespace\": \"\",\n      \"taskQueue\": {\n        \"name\": \"gdrive-main-2\",\n        \"kind\": \"Normal\"\n      },\n      \"header\": {\n        \"fields\": {}\n      },\n      \"input\": {\n        \"payloads\": []\n      },\n      \"scheduleToCloseTimeout\": 5400,\n      \"scheduleToStartTimeout\": 1800,\n      \"startToCloseTimeout\": 3600,\n      \"heartbeatTimeout\": 30,\n      \"workflowTaskCompletedEventId\": \"4\",\n      \"retryPolicy\": {\n        \"nonRetryableErrorTypes\": [],\n        \"initialInterval\": 90,\n        \"backoffCoefficient\": 4,\n        \"maximumInterval\": 86400,\n        \"maximumAttempts\": 3\n      },\n      \"eventId\": \"5\",\n      \"eventType\": \"ActivityTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:30 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"activityId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"activityType.name\",\n          \"value\": \"GetUsersActivity\"\n        },\n        {\n          \"key\": \"namespace\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrive-main-2\"\n            }\n          },\n          \"value\": \"gdrive-main-2\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Normal\"\n        },\n        {\n          \"key\": \"input\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"scheduleToCloseTimeout\",\n          \"value\": 5400\n        },\n        {\n          \"key\": \"scheduleToStartTimeout\",\n          \"value\": 1800\n        },\n        {\n          \"key\": \"startToCloseTimeout\",\n          \"value\": 3600\n        },\n        {\n          \"key\": \"heartbeatTimeout\",\n          \"value\": 30\n        },\n        {\n          \"key\": \"workflowTaskCompletedEventId\",\n          \"value\": \"4\"\n        },\n        {\n          \"key\": \"retryPolicy.initialInterval\",\n          \"value\": 90\n        },\n        {\n          \"key\": \"retryPolicy.backoffCoefficient\",\n          \"value\": 4\n        },\n        {\n          \"key\": \"retryPolicy.maximumInterval\",\n          \"value\": 86400\n        },\n        {\n          \"key\": \"retryPolicy.maximumAttempts\",\n          \"value\": 3\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:30 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:30 pm\",\n    \"timeElapsedDisplay\": \"1s\",\n    \"eventSummary\": {\n      \"Close Timeout\": \"\",\n      \"UploadId\": \"5\",\n      \"input\": {\n        \"payloads\": []\n      },\n      \"Name\": \"GetUsersActivity\",\n      \"eventId\": \"5\",\n      \"eventType\": \"ActivityTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"Close Timeout\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"UploadId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"input\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"Name\",\n          \"value\": \"GetUsersActivity\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"activityId\": \"5\",\n      \"activityType\": {\n        \"name\": \"GetUsersActivity\"\n      },\n      \"namespace\": \"\",\n      \"taskQueue\": {\n        \"name\": \"gdrive-main-2\",\n        \"kind\": \"Normal\"\n      },\n      \"header\": {\n        \"fields\": {}\n      },\n      \"input\": {\n        \"payloads\": []\n      },\n      \"scheduleToCloseTimeout\": 5400,\n      \"scheduleToStartTimeout\": 1800,\n      \"startToCloseTimeout\": 3600,\n      \"heartbeatTimeout\": 30,\n      \"workflowTaskCompletedEventId\": \"4\",\n      \"retryPolicy\": {\n        \"nonRetryableErrorTypes\": [],\n        \"initialInterval\": 90,\n        \"backoffCoefficient\": 4,\n        \"maximumInterval\": 86400,\n        \"maximumAttempts\": 3\n      },\n      \"eventId\": \"5\",\n      \"eventType\": \"ActivityTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"activityId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"activityType.name\",\n          \"value\": \"GetUsersActivity\"\n        },\n        {\n          \"key\": \"namespace\",\n          \"value\": \"\"\n        },\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrive-main-2\"\n            }\n          },\n          \"value\": \"gdrive-main-2\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Normal\"\n        },\n        {\n          \"key\": \"input\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"scheduleToCloseTimeout\",\n          \"value\": 5400\n        },\n        {\n          \"key\": \"scheduleToStartTimeout\",\n          \"value\": 1800\n        },\n        {\n          \"key\": \"startToCloseTimeout\",\n          \"value\": 3600\n        },\n        {\n          \"key\": \"heartbeatTimeout\",\n          \"value\": 30\n        },\n        {\n          \"key\": \"workflowTaskCompletedEventId\",\n          \"value\": \"4\"\n        },\n        {\n          \"key\": \"retryPolicy.initialInterval\",\n          \"value\": 90\n        },\n        {\n          \"key\": \"retryPolicy.backoffCoefficient\",\n          \"value\": 4\n        },\n        {\n          \"key\": \"retryPolicy.maximumInterval\",\n          \"value\": 86400\n        },\n        {\n          \"key\": \"retryPolicy.maximumAttempts\",\n          \"value\": 3\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:30.000Z\",\n    \"eventType\": \"ActivityTaskStarted\",\n    \"eventId\": \"6\",\n    \"details\": {\n      \"scheduledEventId\": \"5\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"requestId\": \"99820161-61f4-4b63-9c58-446f0192b167\",\n      \"attempt\": 1,\n      \"lastFailure\": null,\n      \"eventId\": \"6\",\n      \"eventType\": \"ActivityTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:30 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"6\"\n        },\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"requestId\",\n          \"value\": \"99820161-61f4-4b63-9c58-446f0192b167\"\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:30 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:30 pm\",\n    \"timeElapsedDisplay\": \"1s\",\n    \"eventSummary\": {\n      \"attempt\": 1,\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"requestId\": \"99820161-61f4-4b63-9c58-446f0192b167\",\n      \"eventId\": \"6\",\n      \"eventType\": \"ActivityTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"requestId\",\n          \"value\": \"99820161-61f4-4b63-9c58-446f0192b167\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"scheduledEventId\": \"5\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"requestId\": \"99820161-61f4-4b63-9c58-446f0192b167\",\n      \"attempt\": 1,\n      \"lastFailure\": null,\n      \"eventId\": \"6\",\n      \"eventType\": \"ActivityTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"requestId\",\n          \"value\": \"99820161-61f4-4b63-9c58-446f0192b167\"\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:31.000Z\",\n    \"eventType\": \"ActivityTaskCompleted\",\n    \"eventId\": \"7\",\n    \"details\": {\n      \"result\": {\n        \"payloads\": []\n      },\n      \"scheduledEventId\": \"5\",\n      \"startedEventId\": \"6\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"eventId\": \"7\",\n      \"eventType\": \"ActivityTaskCompleted\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:31 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"7\"\n        },\n        {\n          \"key\": \"result\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"startedEventId\",\n          \"value\": \"6\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:31 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:31 pm\",\n    \"timeElapsedDisplay\": \"2s (+1s)\",\n    \"eventSummary\": {\n      \"result\": {\n        \"payloads\": []\n      },\n      \"eventId\": \"7\",\n      \"eventType\": \"ActivityTaskCompleted\",\n      \"kvps\": [\n        {\n          \"key\": \"result\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"result\": {\n        \"payloads\": []\n      },\n      \"scheduledEventId\": \"5\",\n      \"startedEventId\": \"6\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"eventId\": \"7\",\n      \"eventType\": \"ActivityTaskCompleted\",\n      \"kvps\": [\n        {\n          \"key\": \"result\",\n          \"value\": {\n            \"jsonStringDisplay\": \"{\\n  \\\"payloads\\\": []\\n}\",\n            \"jsonStringFull\": \"{\\n  \\\"payloads\\\": []\\n}\"\n          }\n        },\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"5\"\n        },\n        {\n          \"key\": \"startedEventId\",\n          \"value\": \"6\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:31.000Z\",\n    \"eventType\": \"WorkflowTaskScheduled\",\n    \"eventId\": \"8\",\n    \"details\": {\n      \"taskQueue\": {\n        \"name\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\",\n        \"kind\": \"Sticky\"\n      },\n      \"startToCloseTimeout\": 60,\n      \"attempt\": 1,\n      \"eventId\": \"8\",\n      \"eventType\": \"WorkflowTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:31 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"8\"\n        },\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\"\n            }\n          },\n          \"value\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Sticky\"\n        },\n        {\n          \"key\": \"startToCloseTimeout\",\n          \"value\": 60\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:31 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:31 pm\",\n    \"timeElapsedDisplay\": \"2s\",\n    \"eventSummary\": {\n      \"Taskqueue\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\",\n      \"Timeout\": \"\",\n      \"eventId\": \"8\",\n      \"eventType\": \"WorkflowTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"Taskqueue\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\"\n            }\n          },\n          \"value\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\"\n        },\n        {\n          \"key\": \"Timeout\",\n          \"value\": \"\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"taskQueue\": {\n        \"name\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\",\n        \"kind\": \"Sticky\"\n      },\n      \"startToCloseTimeout\": 60,\n      \"attempt\": 1,\n      \"eventId\": \"8\",\n      \"eventType\": \"WorkflowTaskScheduled\",\n      \"kvps\": [\n        {\n          \"key\": \"taskQueue.name\",\n          \"routeLink\": {\n            \"name\": \"task-queue\",\n            \"params\": {\n              \"taskQueue\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\"\n            }\n          },\n          \"value\": \"gdrivedlp-prod-75749c5c59-gqhmf:c5ddc96c-63d3-47ff-a9b5-ac889934f3cc\"\n        },\n        {\n          \"key\": \"taskQueue.kind\",\n          \"value\": \"Sticky\"\n        },\n        {\n          \"key\": \"startToCloseTimeout\",\n          \"value\": 60\n        },\n        {\n          \"key\": \"attempt\",\n          \"value\": 1\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:54:31.000Z\",\n    \"eventType\": \"WorkflowTaskStarted\",\n    \"eventId\": \"9\",\n    \"details\": {\n      \"scheduledEventId\": \"8\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"requestId\": \"aa9cebf1-9cd9-48dc-814f-05cd6c787148\",\n      \"eventId\": \"9\",\n      \"eventType\": \"WorkflowTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:54:31 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"9\"\n        },\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"8\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"requestId\",\n          \"value\": \"aa9cebf1-9cd9-48dc-814f-05cd6c787148\"\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:54:31 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:54:31 pm\",\n    \"timeElapsedDisplay\": \"2s\",\n    \"eventSummary\": {\n      \"requestId\": \"aa9cebf1-9cd9-48dc-814f-05cd6c787148\",\n      \"eventId\": \"9\",\n      \"eventType\": \"WorkflowTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"requestId\",\n          \"value\": \"aa9cebf1-9cd9-48dc-814f-05cd6c787148\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"scheduledEventId\": \"8\",\n      \"identity\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\",\n      \"requestId\": \"aa9cebf1-9cd9-48dc-814f-05cd6c787148\",\n      \"eventId\": \"9\",\n      \"eventType\": \"WorkflowTaskStarted\",\n      \"kvps\": [\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"8\"\n        },\n        {\n          \"key\": \"identity\",\n          \"value\": \"1@gdrivedlp-prod-75749c5c59-gqhmf@\"\n        },\n        {\n          \"key\": \"requestId\",\n          \"value\": \"aa9cebf1-9cd9-48dc-814f-05cd6c787148\"\n        }\n      ]\n    }\n  },\n  {\n    \"eventTime\": \"2021-01-08T00:55:31.000Z\",\n    \"eventType\": \"WorkflowTaskTimedOut\",\n    \"eventId\": \"10\",\n    \"details\": {\n      \"scheduledEventId\": \"8\",\n      \"startedEventId\": \"9\",\n      \"timeoutType\": \"StartToClose\",\n      \"eventId\": \"10\",\n      \"eventType\": \"WorkflowTaskTimedOut\",\n      \"kvps\": [\n        {\n          \"key\": \"eventTime\",\n          \"value\": \"Jan 7th 4:55:31 pm\"\n        },\n        {\n          \"key\": \"eventId\",\n          \"value\": \"10\"\n        },\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"8\"\n        },\n        {\n          \"key\": \"startedEventId\",\n          \"value\": \"9\"\n        },\n        {\n          \"key\": \"timeoutType\",\n          \"value\": \"StartToClose\"\n        }\n      ],\n      \"eventTime\": \"Jan 7th 4:55:31 pm\"\n    },\n    \"eventTimeDisplay\": \"Jan 7th 4:55:31 pm\",\n    \"timeElapsedDisplay\": \"1m 2s (+1m)\",\n    \"eventSummary\": {\n      \"Timeout Type\": \"StartToClose\",\n      \"eventId\": \"10\",\n      \"eventType\": \"WorkflowTaskTimedOut\",\n      \"kvps\": [\n        {\n          \"key\": \"Timeout Type\",\n          \"value\": \"StartToClose\"\n        }\n      ]\n    },\n    \"eventFullDetails\": {\n      \"scheduledEventId\": \"8\",\n      \"startedEventId\": \"9\",\n      \"timeoutType\": \"StartToClose\",\n      \"eventId\": \"10\",\n      \"eventType\": \"WorkflowTaskTimedOut\",\n      \"kvps\": [\n        {\n          \"key\": \"scheduledEventId\",\n          \"value\": \"8\"\n        },\n        {\n          \"key\": \"startedEventId\",\n          \"value\": \"9\"\n        },\n        {\n          \"key\": \"timeoutType\",\n          \"value\": \"StartToClose\"\n        }\n      ]\n    }\n  }\n]")
}
